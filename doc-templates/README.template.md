<!--

NOTICE: THIS FILE IS AUTOGENERATED FROM docs/README.template.md

This file is evaled by a quickly cobbled together bash script to replace the variables.

Backticks are imterpreted by bash so use <code> for inline code and <pre> for code blocks.

If you need to include bsah code snippets you will need to change how the templating works.

-->

# Simulator

A distributed systems and infrastructure simulator for attacking and debugging Kubernetes

## AWS Configuration

Simulator uses terraform to provision its infrastructure.  Terraform in turn
honours [all the rules for configuring the AWS
CLI](https://docs.aws.amazon.com/cli/latest/userguide/cli-chap-configure.html#cli-environment).
Please follow these.

You can provide your credentials via the <code>AWS_ACCESS_KEY_ID</code> and
<code>AWS_SECRET_ACCESS_KEY</code>, environment variables, representing your AWS Access Key
and AWS Secret Key, respectively. Note that setting your AWS credentials using
either these (or legacy) environment variables will override the use of
<code>AWS_SHARED_CREDENTIALS_FILE</code> and <code>AWS_PROFILE</code>. The <code>AWS_DEFAULT_REGION</code> and
<code>AWS_SESSION_TOKEN</code> environment variables are also used, if applicable.

https://www.terraform.io/docs/backends/types/s3.html

**All the <code>AWS_*</code> configuration environment variables you have set will be propagated into the container**

### Troubleshooting AWS

- <code>AWS_REGION</code> vs <code>AWS_DEFAULT_REGION</code> - There have been
[some issues](https://github.com/aws/aws-sdk-go/issues/2103) with the
[Go AWS client region configuration](https://github.com/aws/aws-sdk-go#configuring-aws-region)
- [Multi-account](https://www.terraform.io/docs/backends/types/s3.html#multi-account-aws-architecture)

## Before you start

Create an S3 bucket to store the remote state which keeps track of what infrastructure has been provisioned.
[There are instructions here](./docs/remote-state.md)

## Usage

The quickest way to get up and running is to simply:

<pre>
make run
</pre>

This will drop you into a bash shell in a launch container.  You will have a
program on the <code>PATH</code> named <code>simulator</code> to interact with.

### [Simulator CLI Usage](./docs/cli.md)

### tldr;

<pre>
# Create the infra if it isn't there
simulator infra create
# Configure your SSH to perturb the cluster
simulator ssh config --write
# Launch a scenario (runs perturb.sh)
simulator scenario launch database_compromise
# Attack the cluster
simulator ssh attack
</pre>

## SSH Keys

If using with <code>make run</code> the default RSA keypair on your host
machine (I.E. <code>~/.ssh/id_rsa{,.pub}</code> will be setup as an authorised
key on the infrastructure. If your key has a passphrase (it should :)) then you
will need to make sure you have <code>ssh-add</code>ed to SSH agent.  The SSH
agent sock is mounted in the container and SSH is configured to use it.

## Development Workflow

Development targets are specified in the [Makefile](./Makefile).

<pre>
${make}
</pre>

## Architecture

### [Launching a scenario](./docs/launch.md)

### *TODO* [Validating a scenario](./docs/validation.md)

### *TODO* [Evaluating  scenario progress](./docs/evaluation.md)

### Components

* [Simulator CLI tool](./cmd) - Runs in the launch container and orchestrates everything
* [Launch container](./Dockerfile) - Isolates the scripts from the host
* [Terraform Scripts for infrastructure provisioning](./terraform) - AWS infra
* [Perturb.sh](./simulation-scripts/perturb.sh) - sets up a scenario on a cluster
* [Scenarios](./simulation-scripts/scenario)
* [Attack container](./attack) - Runs on the bastion providing all the tools needed to attack a
cluster in the given cloud provider

### Simulator API Documentation

* [Scenario](./docs/api/scenario.md)
* [Simulator](./docs/api/simulator.md)
* [Util](./docs/api/util.md)

## Project Roadmap

There is a [roadmap](./docs/roadmap.md) outlining current and planned work.
